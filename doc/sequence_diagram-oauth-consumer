title gluu-oauth2-client plugin access phase

Kong Proxy->gluu-oauth2-client-plugin: *****  call "access" phase for gluu-oauth2-client-plugin  *****

opt OAuth Mode
    opt no token
        gluu-oauth2-client-plugin->Kong Proxy: 401 Unauthorized
    end
    gluu-oauth2-client-plugin->kong-cache: Lookup token in cache
    opt token not cached
        gluu-oauth2-client-plugin<->oxd-web: Introspect OAuth token
        opt introspection fails
            gluu-oauth2-client-plugin->Kong Proxy: Unauthorized 401 - token can't be validated
        end
        opt token != active | token expired
            gluu-oauth2-client-plugin->client: Unauthorized 401 - token expired or inactive
        end
        gluu-oauth2-client-plugin<->kong_db: fetch oauth2 consumer_id using client_id {id:'..', oxd_id:'..', ..., kong_act_as_uma_client:[t|f], native_uma_client:[t|f] }
        gluu-oauth2-client-plugin->kong-cache: write "token": {token JSON}
    end
    gluu-oauth2-client-plugin->gluu-oauth2-client-plugin: Add OAUTH_SCOPE, OAUTH_EXP, OAUTH_CLIENT_ID headers
    gluu-oauth2-client-plugin->Kong Proxy: return
end

opt UMA Mode
    opt no token
        gluu-oauth2-client-plugin->Kong Proxy: return (it's ok--RS needs to return UMA ticket)
    end
    gluu-oauth2-client-plugin->kong-cache: Lookup token in cache
    opt token not cached
        gluu-oauth2-client-plugin<->oxd-web: Introspect UMA token
        opt introspection fails
            gluu-oauth2-client-plugin->Kong Proxy: Unauthorized 401 - token can't be validated
        end
        opt token != active | token expired
            gluu-oauth2-client-plugin->client: Unauthorized 401 - token expired or inactive
        end
        gluu-oauth2-client-plugin<->kong_db: fetch oauth2 consumer_id using client_id {id:'..', oxd_id:'..', ..., kong_act_as_uma_client:[t|f], native_uma_client:[t|f] }
        gluu-oauth2-client-plugin->kong-cache: write "token": {token JSON}
    end
end

opt Mix Mode
    opt no token
        gluu-oauth2-client-plugin->Kong Proxy: 401 Unauthorized
    end
    gluu-oauth2-client-plugin->kong-cache: Lookup token in cache
    opt token not cached
        gluu-oauth2-client-plugin<->oxd-web: Introspect OAuth token
        opt introspection fails
            gluu-oauth2-client-plugin->Kong Proxy: Unauthorized 401 - token can't be validated
        end
        opt token != active | token expired
            gluu-oauth2-client-plugin->client: Unauthorized 401 - token expired or inactive
        end
        gluu-oauth2-client-plugin<->kong_db: fetch oauth2 consumer_id using client_id {id:'..', oxd_id:'..', ..., kong_act_as_uma_client:[t|f], native_uma_client:[t|f] }
        gluu-oauth2-client-plugin->kong-cache: write "token": {token JSON}
    end
    gluu-oauth2-client-plugin->gluu-oauth2-client-plugin: check JSON for associated_rpt token
    opt associated_rpt exists
        replace Authorization Header:  Authorization: Bearer RPT
    end
end
