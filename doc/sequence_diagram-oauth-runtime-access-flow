title gluu-client-auth plugin access

client->Kong Proxy: call API with header Authorization: Bearer AT
opt push claim
    client->Kong Proxy: Add Header "UMA Data": {"claim_token":"...","claim_token_format":"..."}
end

Kong Proxy->gluu-client-auth-plugin: *****  call "access" event for Kong OAuth-Consumer plugin priority 999 *****

opt no token
    gluu-client-auth-plugin->Kong Proxy: 401 / Unauthorized
end

gluu-client-auth-plugin->kong-cache: Lookup token in cache

opt token not in cache
    gluu-client-auth-plugin->kong-cache: Lookup permission token in cache
    opt no permission token in cache
        gluu-client-auth-plugin<->oxd: GET protection_access_token
    end

    gluu-client-auth-plugin<->oxd: Introspect AT at OAuth Introspection endpoint
    opt active == false || token expired
        gluu-client-auth-plugin->Kong Proxy: 401 / Unauthorized - token expired
    end
    gluu-client-auth-plugin<->kong_db: fetch consumer using client_id
    opt consumer == null
        gluu-client-auth-plugin->Kong Proxy: 401 / Unauthorized - Invalid client
    end
    opt &(allow_oauth_scope_expression == true and oauth_scope_expression is not match with token scope)
        gluu-client-auth-plugin->Kong Proxy: 401 / Unauthorized - Scope validation failed
    end
    gluu-client-auth-plugin->kong-cache: write "token": {token JSON}
    kong-cache->kong_db: add "token": {token JSON}
end

kong-cache->gluu-client-auth-plugin: return token JSON

gluu-client-auth-plugin->gluu-client-auth-plugin: Add OAUTH_SCOPE, OAUTH_EXP, OAUTH_CLIENT_ID headers
gluu-client-auth-plugin->Kong Proxy: return
