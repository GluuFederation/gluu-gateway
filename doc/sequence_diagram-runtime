title OAuth Consumer Runtime

client->OP: ***** request UMA or OAuth token *****
OP->client: token AT
client->Kong Proxy: call API with header Authorization: Bearer AT
opt push claim
    client->Kong Proxy: Add Header "UMA Data": [{"claim_token":"...","claim_token_format":"..."}]
end

Kong Proxy->oauth2-plugin: *****  call "access" event for Kong OAuth-Consumer plugin priority 999 *****

oauth2-plugin->kong-cache: Lookup token in cache

opt token not in cache
    oauth2-plugin<->oxd-web: Introspect AT at OAuth Introspection endpoint
    opt OAuth token introspection fails
        opt native_uma_client enabled
            oauth2-plugin<->oxd-web: Introspect RPT at token introspection endpoint
            opt RPT token introspection fails
                oauth2-plugin->Kong Proxy: Unauthorized 401 - token can't be validated
            end
        end
        opt native_uma_client disabled
            oauth2-plugin->Kong Proxy: Unauthorized 401 - token can't be validated
        end
    end
    opt token != active | token expired
        oauth2-plugin->client: Unauthorized 401 - token expired
    end
    oauth2-plugin->kong-cache: write "token": {token JSON}
end

kong-cache->oauth2-plugin: return token JSON

opt &(token_type == OAuth)(handleUMA == true)
    oauth2-plugin->kong-cache: lookup associated RPT JSON
    opt RPT found
        oauth2-plugin->oauth2-plugin: replace Authoriation Header with associated UMA token
    end
end

oauth2-plugin->Kong Proxy:

Kong Proxy->oauth2-plugin: *****  call "header_filter" event for Kong plugin priority 998 *****

opt &(HTTP response 401)(kong_acts_as_uma_client enabled)
    oauth2-plugin-> oauth2-plugin: Get ticket from WWW-Authenticate header
    oauth2-plugin-> oauth2-plugin: Get token from Request Authorization header
    oauth2-plugin-> oauth2-plugin: Extract claim tokens from UMA_CLAIM_TOKENS header
    oauth2-plugin->kong-cache: Lookup token
    opt token is OAuth AT
        oauth2-plugin->oxd-web: get_rpt(oxd-id, ticket, claims_token, claims_token_format)
    end
    opt token is UMA RPT
        oauth2-plugin->oxd-web: get_rpt(oxd-id, ticket, RPT, claims_token, claims_token_format)
    end
    opt oxd-web returns RPT
        oauth2-plugin->kong-cache: write RPT token; update OAuth token (add RPT reference)
        oauth2-plugin->Kong Proxy: 205 Reset Content
    end
    opt oxd-web returns anything other then RPT
        oauth2-plugin->client: 403 Forbidden (add descriptive error msg to new header KONG_UMA_ERROR)
    end
end
