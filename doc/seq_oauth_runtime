title Gluu-OAuth-Auth and PEP plugin access

Kong Proxy->gluu-oauth-auth: *****  call "access" priority 999 *****

opt no token
    gluu-oauth-auth->Kong Proxy: 401 / Unauthorized
end

gluu-oauth-auth->kong-cache: Lookup token in cache

opt token not in cache
    gluu-oauth-auth<->oxd: Introspect AT at OAuth Introspection endpoint
    opt active == false || token expired
        gluu-oauth-auth->Kong Proxy: 401 / Unauthorized - token expired
    end
    gluu-oauth-auth<->kong_db: fetch consumer using client_id
    opt consumer == null
        gluu-oauth-auth->Kong Proxy: 401 / Unauthorized - Invalid client
    end
    gluu-oauth-auth->kong-cache: write "token": {token JSON}
end

kong-cache->gluu-oauth-auth: return token JSON

gluu-oauth-auth->gluu-oauth-auth: Add OAUTH_SCOPE, OAUTH_EXP, OAUTH_CLIENT_ID headers

Kong Proxy->gluu-oauth-pep: *****  call "access" priority 998 *****

gluu-oauth-pep->kong-cache: Lookup token+scope in cache

opt token+scope not in cache
    opt ngx context token scope not match oauth_scope_expression
        gluu-oauth-pep->Kong Proxy: 401 / Unauthorized - Scope validation failed
    end
end

gluu-oauth-pep->Kong Proxy: return